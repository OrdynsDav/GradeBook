/**
 * Типы API GradeBook Backend для использования на фронте.
 * Base URL: http://localhost:3000 (или ваш хост)
 * Префикс: /api/v1
 * Все даты в формате ISO 8601 (UTC).
 */

// ============ Enums (соответствуют бэкенду) ============

export type Role = 'student' | 'teacher' | 'admin';

import type { ThemeMode } from '@shared/config/theme';

export type NotificationType = 'grade' | 'homework' | 'announcement' | 'system';

export type NotificationStatus = 'unread' | 'read';

/** Фильтр списка уведомлений: all | read | unread */
export type NotificationFilterStatus = 'all' | 'read' | 'unread';

/** Роль при создании пользователя админом (только student | teacher) */
export type CreatableRole = 'student' | 'teacher';

// ============ Auth ============

export interface LoginRequest {
  login: string;
  password: string;
}

export interface RefreshRequest {
  refreshToken: string;
}

export interface LogoutRequest {
  refreshToken: string;
}

export interface ClassRoom {
  id: string;
  name: string;
  course: number;
  groupName: string;
}

/** Пользователь в ответах API. В login/refresh приходит только classRoomId; в /users/me и ответе создания пользователя может приходить classRoom. */
export interface User {
  id: string;
  login: string;
  role: Role;
  firstName: string;
  lastName: string;
  middleName?: string | null;
  /** Приходит в login/refresh */
  classRoomId?: string | null;
  /** Приходит в GET/PATCH /users/me и в ответе POST /users (admin) */
  classRoom?: ClassRoom | null;
  createdAt: string;
  updatedAt: string;
}

export interface AuthResponse {
  accessToken: string;
  refreshToken: string;
  /** Время жизни access токена в секундах (например 900) */
  expiresIn: number;
  user: User;
}

export interface LogoutResponse {
  success: boolean;
}

// ============ User (me, admin create) ============

export interface UpdateMeRequest {
  firstName?: string;
  lastName?: string;
  middleName?: string;
}

export interface CreateUserByAdminRequest {
  role: CreatableRole;
  firstName: string;
  lastName: string;
  middleName?: string;
  /** Обязательно для student (1–8) */
  course?: number;
  /** Обязательно для student */
  group?: string;
  login: string;
  password: string;
}

// ============ Dashboard ============

export interface SubjectRef {
  id: string;
  name: string;
}

export interface TeacherRef {
  id: string;
  firstName: string;
  lastName: string;
  middleName?: string | null;
}

/** Урок в расписании (schedule/week, schedule/day, dashboard todaySchedule). classRoom в dashboard может быть только { id, name }. */
export interface LessonItem {
  id: string;
  startsAt: string;
  endsAt: string;
  room?: string | null;
  subject: SubjectRef;
  classRoom?: ClassRoom | { id: string; name: string };
  teacher: TeacherRef;
}

export interface DashboardResponse {
  averageGrade: number | null;
  lessonsToday: number;
  unreadNotifications: number;
  todaySchedule: LessonItem[];
}

// ============ Subjects ============

export interface SubjectListItem {
  id: string;
  name: string;
  classRoomId: string;
  teacherId: string;
  classRoom?: { id: string; name: string };
  teacher?: TeacherRef;
  createdAt?: string;
  updatedAt?: string;
}

export interface SubjectsQueryParams {
  classRoomId?: string;
  teacherId?: string;
}

// ============ Grades ============

export interface StudentRef {
  id: string;
  firstName: string;
  lastName: string;
  middleName?: string | null;
}

export interface GradeItem {
  id: string;
  subjectId: string;
  studentId: string;
  createdById: string;
  value: number;
  comment?: string | null;
  gradedAt: string;
  student?: StudentRef;
  createdBy?: TeacherRef;
  createdAt?: string;
  updatedAt?: string;
}

export interface CreateGradeRequest {
  studentId: string;
  value: number; // 1–5
  comment?: string;
  /** ISO 8601, по умолчанию — сейчас */
  gradedAt?: string;
}

export interface UpdateGradeRequest {
  value?: number; // 1–5
  comment?: string;
  gradedAt?: string;
}

// ============ Schedule ============

export interface CreateLessonRequest {
  subjectId: string;
  startsAt: string; // ISO 8601
  endsAt: string;   // ISO 8601
  room?: string;
}

export interface UpdateLessonRequest {
  subjectId?: string;
  startsAt?: string;
  endsAt?: string;
  room?: string;
}

export interface ScheduleQueryParams {
  /** YYYY-MM-DD */
  date: string;
  classRoomId?: string;
  teacherId?: string;
}

/** Ответ GET /schedule/week */
export interface ScheduleWeekResponse {
  items: LessonItem[];
  weekStart?: string;
  weekEnd?: string;
}

// ============ Notifications ============

export interface NotificationItem {
  id: string;
  userId: string;
  title: string;
  body: string;
  type: NotificationType;
  status: NotificationStatus;
  readAt?: string | null;
  createdAt: string;
  updatedAt: string;
}

export interface NotificationsListResponse {
  items: NotificationItem[];
  page: number;
  limit: number;
  total: number;
  totalPages: number;
}

export interface NotificationsQueryParams {
  status?: NotificationFilterStatus;
  page?: number;
  limit?: number; // max 100
}

export interface NotificationsReadAllResponse {
  updated: number;
}

// ============ Settings ============

export interface NotificationsSettings {
  enabled?: boolean;
  grades?: boolean;
  homework?: boolean;
  announcements?: boolean;
}

export interface SettingsResponse {
  themeMode: ThemeMode;
  notifications: NotificationsSettings;
}

export interface UpdateSettingsRequest {
  themeMode?: ThemeMode;
  notifications?: NotificationsSettings;
}

// ============ Errors (стандартный формат бэкенда) ============

export interface ApiErrorResponse {
  statusCode: number;
  message: string | string[];
  error?: string;
  path?: string;
  timestamp?: string;
  requestId?: string;
}

// ============ Frontend: классы ошибок и алиасы для совместимости ============

export class NetworkError extends Error {
  constructor(message: string) {
    super(message);
    this.name = 'NetworkError';
  }
}

export class ApiRequestError extends Error {
  constructor(
    public readonly status: number,
    public readonly details: ApiErrorResponse,
    message?: string
  ) {
    const msg =
      message ??
      (Array.isArray(details.message) ? details.message.join(', ') : details.message);
    super(msg);
    this.name = 'ApiRequestError';
  }
}

/** Сообщение для показа пользователю по ошибке API/сети. */
export function getApiErrorMessage(error: unknown, fallback = 'Неизвестная ошибка'): string {
  if (error instanceof NetworkError) return error.message || 'Проблема с подключением';
  if (error instanceof ApiRequestError) {
    if (error.status === 401) return 'Неверный логин или пароль';
    if (error.status >= 500) return 'Ошибка сервера. Попробуйте позже';
    return error.message || 'Ошибка запроса';
  }
  return fallback;
}

/** Алиасы для обратной совместимости с экранами */
export type LessonDetail = LessonItem;
export type UserSettings = SettingsResponse;
export type Notification = NotificationItem;
export type NotificationsResponse = NotificationsListResponse;
/** Subject в API — SubjectListItem; для экранов с расширенными полями можно расширять локально */
export type Subject = SubjectListItem;
export type Grade = GradeItem;
